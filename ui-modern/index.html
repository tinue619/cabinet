<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet Designer - Modern UI</title>
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/cabinet.css">
</head>
<body>
    <header class="app-header">
        <div class="header-brand">
            <svg class="logo" width="32" height="32" viewBox="0 0 32 32">
                <rect x="4" y="4" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"/>
                <line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="2"/>
                <line x1="16" y1="12" x2="16" y2="28" stroke="currentColor" stroke-width="2"/>
            </svg>
            <h1>Cabinet Designer <span class="version">v4.0</span></h1>
        </div>
        <div class="header-actions">
            <button class="btn-icon" id="btn-export" title="–≠–∫—Å–ø–æ—Ä—Ç">
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <path d="M10 14V3M10 3L6 7M10 3l4 4M3 14v3h14v-3" stroke="currentColor" fill="none" stroke-width="2"/>
                </svg>
            </button>
        </div>
    </header>

    <div class="app-layout">
        <aside class="panel panel-left">
            <div class="panel-header"><h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∫–∞—Ñ–∞</h2></div>
            <div class="panel-content">
                <section class="control-section">
                    <h3>–ì–∞–±–∞—Ä–∏—Ç—ã</h3>
                    <div class="form-group">
                        <label for="cabinet-width">–®–∏—Ä–∏–Ω–∞ (–º–º) <span class="hint">400-2000</span></label>
                        <input type="number" id="cabinet-width" value="800" min="400" max="2000" step="10">
                    </div>
                    <div class="form-group">
                        <label for="cabinet-height">–í—ã—Å–æ—Ç–∞ (–º–º) <span class="hint">600-3000</span></label>
                        <input type="number" id="cabinet-height" value="2000" min="600" max="3000" step="10">
                    </div>
                    <div class="form-group">
                        <label for="cabinet-depth">–ì–ª—É–±–∏–Ω–∞ (–º–º) <span class="hint">300-800</span></label>
                        <input type="number" id="cabinet-depth" value="600" min="300" max="800" step="10">
                    </div>
                    <div class="form-group">
                        <label for="cabinet-base">–¶–æ–∫–æ–ª—å (–º–º) <span class="hint">60-200</span></label>
                        <input type="number" id="cabinet-base" value="100" min="60" max="200" step="5">
                    </div>
                    <button class="btn btn-primary btn-block" id="btn-generate">üîÑ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã</button>
                </section>
            </div>
        </aside>

        <div class="canvas-container">
            <canvas id="cabinet-canvas"></canvas>
            <div class="loading-indicator" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <span>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤...</span>
            </div>
        </div>

        <aside class="panel panel-right">
            <div class="panel-header"><h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2></div>
            <div class="panel-content">
                <section class="stats-section">
                    <div class="stat-item">
                        <span class="stat-label">–ü–∞–Ω–µ–ª–µ–π</span>
                        <span class="stat-value" id="stat-panels">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–û–±—ä–µ–º</span>
                        <span class="stat-value" id="stat-volume">- –º¬≥</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                        <span class="stat-value" id="stat-cost">- ‚ÇΩ</span>
                    </div>
                </section>

                <section class="parts-section">
                    <h3>–°–ø–∏—Å–æ–∫ –ø–∞–Ω–µ–ª–µ–π</h3>
                    <div class="parts-list" id="parts-list">
                        <div class="empty-state">–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–∞–Ω–µ–ª–µ–π</div>
                    </div>
                </section>
            </div>
        </aside>
    </div>

    <div class="status-bar">
        <div class="status-left"><span id="status-message">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span></div>
        <div class="status-right">
            <span>Cabinet Designer v4.0</span>
            <span>‚Ä¢</span>
            <span id="status-core">–Ø–¥—Ä–æ: –∑–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

    <div class="notifications" id="notifications"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —è–¥—Ä–æ –∏–∑ new_core -->
    <script type="module" src="../new_core/index.js"></script>

    <script type="module">
        // üî• –ï–î–ò–ù–´–ô –î–í–ò–ñ–û–ö –í–ú–ï–°–¢–û 4 –†–ï–ù–î–ï–†–ï–†–û–í
        import PanelEngine from '../cabinet-app/src/infrastructure/Universal2DPanelEngine.js';

        // Infrastructure Layer
        class CoreAdapter {
            constructor() {
                this.cabinet = null;
                this.coreModule = null;
                this.system = null;
            }

            async initialize() {
                try {
                    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —è–¥—Ä–æ new_core
                    this.coreModule = await import('../new_core/index.js');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤
                    if (!this.coreModule.Cabinet || !this.coreModule.CABINET_DNA) {
                        throw new Error('–ö–ª–∞—Å—Å Cabinet –∏–ª–∏ CABINET_DNA –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    }
                    return true;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —è–¥—Ä–∞:', error);
                    return false;
                }
            }

            createCabinet(params) {
                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç dimensions
                const dimensions = {
                    width: params.width,
                    height: params.height,
                    depth: params.depth,
                    baseHeight: params.baseHeight || 100
                };
                
                // –°–æ–∑–¥–∞–µ–º —à–∫–∞—Ñ —Å –ø–æ–º–æ—â—å—é –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —è–¥—Ä–∞
                this.cabinet = new this.coreModule.Cabinet(dimensions);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª–∏ —à–∫–∞—Ñ–∞
                this.cabinet.generate();
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏ —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä
                const panels = this.extractPanelsData();
                const stats = this.calculateStats(panels);
                
                // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞
                const data = {
                    dimensions: dimensions,
                    cabinet: this.cabinet // –ü–µ—Ä–µ–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —à–∫–∞—Ñ
                };
                
                return {
                    stats: stats,
                    panels: panels,
                    data: data
                };
            }
            
            // APPLICATION LAYER: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–∞–Ω–µ–ª—è—Ö
            extractPanelsData() {
                if (!this.cabinet) return [];
                
                // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —à–∫–∞—Ñ–∞
                const dimensions = this.cabinet.dimensions;
                const dna = this.coreModule.CABINET_DNA;
                
                const panels = [];
                
                // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ —Å–æ–≥–ª–∞—Å–Ω–æ DNA
                Object.entries(dna.REQUIRED_PANELS).forEach(([key, panelDef]) => {
                    const material = dna.MATERIALS[panelDef.material];
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–∞–Ω–µ–ª–∏ –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º –∏–∑ DNA
                    let w, h, d;
                    
                    switch(key) {
                        case 'LEFT_SIDE':
                        case 'RIGHT_SIDE':
                            w = material.thickness;
                            h = dimensions.height;
                            d = dimensions.depth;
                            break;
                        case 'TOP':
                            w = dimensions.width;
                            h = material.thickness;
                            d = dimensions.depth;
                            break;
                        case 'BOTTOM':
                            w = dimensions.width - 2 * dna.CONSTANTS.DEFAULT_PANEL_THICKNESS;
                            h = material.thickness;
                            d = dimensions.depth;
                            break;
                        case 'FRONT_BASE':
                        case 'BACK_BASE':
                            w = dimensions.width - 2 * dna.CONSTANTS.DEFAULT_PANEL_THICKNESS;
                            h = dimensions.baseHeight;  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –≤—ã—Å–æ—Ç–∞ —Ü–æ–∫–æ–ª—è, –∞ –Ω–µ —Ç–æ–ª—â–∏–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
                            d = material.thickness;     // –ò–°–ü–†–ê–í–õ–ï–ù–û: —Ç–æ–ª—â–∏–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, –∞ –Ω–µ –≥–ª—É–±–∏–Ω–∞ —à–∫–∞—Ñ–∞
                            break;
                        case 'BACK_WALL':
                            w = dimensions.width - 2 * dna.CONSTANTS.DEFAULT_PANEL_THICKNESS;
                            h = dimensions.height - dimensions.baseHeight - dna.CONSTANTS.DEFAULT_PANEL_THICKNESS;
                            d = material.thickness;
                            break;
                        case 'FACADE':
                            w = dimensions.width;
                            h = dimensions.height - dimensions.baseHeight;
                            d = material.thickness;
                            break;
                        default:
                            w = 100; h = 100; d = material.thickness;
                    }
                    
                    panels.push({
                        name: panelDef.name,
                        w: Math.round(w),
                        h: Math.round(h), 
                        d: Math.round(d),
                        material: material.name,
                        type: panelDef.type
                    });
                });
                
                return panels;
            }
            
            // APPLICATION LAYER: –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            calculateStats(panels) {
                let totalVolume = 0;
                let totalCost = 0;
                
                // –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã –∑–∞ –∫—É–±–∏—á–µ—Å–∫–∏–π –º–µ—Ç—Ä
                const materialPrices = {
                    '–õ–î–°–ü 16–º–º': 25000,
                    '–•–î–§ 3–º–º': 15000,
                    '–ú–î–§ 16–º–º': 35000
                };
                
                panels.forEach(panel => {
                    // –û–±—ä–µ–º –≤ –∫—É–±–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∞—Ö
                    const volumeM3 = (panel.w * panel.h * panel.d) / (1000 * 1000 * 1000);
                    totalVolume += volumeM3;
                    
                    // –°—Ç–æ–∏–º–æ—Å—Ç—å
                    const price = materialPrices[panel.material] || 25000;
                    totalCost += volumeM3 * price;
                });
                
                return {
                    totalPanels: panels.length,
                    totalVolume: totalVolume.toFixed(3),
                    estimatedCost: Math.round(totalCost).toLocaleString('ru-RU')
                };
            }
        }

        // Application Layer
        class AppService {
            constructor(coreAdapter, uiManager) {
                this.core = coreAdapter;
                this.ui = uiManager;
                this.currentCabinet = null;
            }

            async initialize() {
                this.ui.showStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞...');
                const success = await this.core.initialize();
                if (success) {
                    this.ui.showStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                    this.ui.setCoreStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
                    this.ui.showNotification('success', '–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!');
                } else {
                    this.ui.showStatus('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
                    this.ui.setCoreStatus('–û—à–∏–±–∫–∞');
                    this.ui.showNotification('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —è–¥—Ä—É');
                }
                return success;
            }

            async generateCabinet(dimensions) {
                try {
                    this.ui.showLoading(true);
                    this.ui.showStatus('–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤...');
                    const result = this.core.createCabinet(dimensions);
                    this.currentCabinet = result;
                    this.ui.updateStats(result.stats);
                    this.ui.updatePanelsList(result.panels);
                    this.ui.renderCabinet(result);
                    this.ui.showLoading(false);
                    this.ui.showStatus('–†–∞–∑–º–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
                    this.ui.showNotification('success', '–†–∞–∑–º–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!');
                } catch (error) {
                    this.ui.showLoading(false);
                    this.ui.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
                    this.ui.showNotification('error', `–û—à–∏–±–∫–∞: ${error.message}`);
                }
            }
        }

        // UI Layer
        class UIManager {
            constructor() {
                this.elements = this.getElements();
                this.canvas = this.elements.canvas;
                
                this.setupCanvas();
                
                console.log('üî• UIManager —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π –¥–≤–∏–∂–æ–∫!');
            }

            getElements() {
                return {
                    canvas: document.getElementById('cabinet-canvas'),
                    loading: document.getElementById('loading'),
                    statusMessage: document.getElementById('status-message'),
                    statusCore: document.getElementById('status-core'),
                    statPanels: document.getElementById('stat-panels'),
                    statVolume: document.getElementById('stat-volume'),
                    statCost: document.getElementById('stat-cost'),
                    partsList: document.getElementById('parts-list'),
                    notifications: document.getElementById('notifications')
                };
            }

            setupCanvas() {
                const resizeCanvas = () => {
                    const container = this.canvas.parentElement;
                    this.canvas.width = container.clientWidth;
                    this.canvas.height = container.clientHeight;
                };
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
            }

            showLoading(show) {
                this.elements.loading.style.display = show ? 'flex' : 'none';
            }

            showStatus(message) {
                this.elements.statusMessage.textContent = message;
            }

            setCoreStatus(status) {
                this.elements.statusCore.textContent = `–Ø–¥—Ä–æ: ${status}`;
            }

            updateStats(stats) {
                this.elements.statPanels.textContent = stats.totalPanels || 0;
                this.elements.statVolume.textContent = `${stats.totalVolume || 0} –º¬≥`;
                this.elements.statCost.textContent = `${stats.estimatedCost || 0} ‚ÇΩ`;
            }

            updatePanelsList(panels) {
                if (!panels || panels.length === 0) {
                    this.elements.partsList.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–∞–Ω–µ–ª–µ–π</div>';
                    return;
                }
                
                const html = panels.map((panel, index) => {
                    // –ü–∞–Ω–µ–ª–∏ —É–∂–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏–∑ getAllParts()
                    const name = panel.name || '–ü–∞–Ω–µ–ª—å ' + (index + 1);
                    const width = Math.round(panel.w || 0);
                    const height = Math.round(panel.h || 0);
                    const depth = Math.round(panel.d || 0);
                    const material = panel.material || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    return `
                        <div class="part-item">
                            <div>
                                <div class="part-name">${name}</div>
                                <div class="part-dimensions">${width}√ó${height}√ó${depth}–º–º</div>
                                <div class="part-material">${material}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.elements.partsList.innerHTML = html;
            }

            renderCabinet(cabinetData) {
                // üî• –ï–¥–∏–Ω—ã–π –¥–≤–∏–∂–æ–∫ –≤–º–µ—Å—Ç–æ 4 —Ä–µ–Ω–¥–µ—Ä–µ—Ä–æ–≤!
                
                if (!cabinetData || !cabinetData.data?.dimensions) {
                    console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞');
                    return;
                }
                
                // ‚ú® –ú–ê–ì–ò–Ø: –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º –µ–¥–∏–Ω—ã–π –¥–≤–∏–∂–æ–∫!
                PanelEngine.renderFullCabinet(this.canvas, {
                    dimensions: cabinetData.data.dimensions
                });
                
                console.log('üé® –†–µ–Ω–¥–µ—Ä —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –¥–≤–∏–∂–æ–∫:', cabinetData.data.dimensions);
            }

            showNotification(type, message) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `<div class="notification-content"><div class="notification-message">${message}</div></div>`;
                this.elements.notifications.appendChild(notification);
                setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 3000);
            }
        }

        // Event Controller
        class EventController {
            constructor(appService, uiManager) {
                this.app = appService;
                this.ui = uiManager;
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('btn-generate').addEventListener('click', () => {
                    this.app.generateCabinet(this.getDimensions());
                });
            }

            getDimensions() {
                return {
                    width: parseInt(document.getElementById('cabinet-width').value),
                    height: parseInt(document.getElementById('cabinet-height').value),
                    depth: parseInt(document.getElementById('cabinet-depth').value),
                    baseHeight: parseInt(document.getElementById('cabinet-base').value)
                };
            }
        }

        // App Initialization
        async function initializeApp() {
            const coreAdapter = new CoreAdapter();
            const uiManager = new UIManager();
            const appService = new AppService(coreAdapter, uiManager);
            const eventController = new EventController(appService, uiManager);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É
            await appService.initialize();
            
            // –°–æ–∑–¥–∞–µ–º —à–∫–∞—Ñ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            const defaultDimensions = {
                width: 800,
                height: 2000,
                depth: 600,
                baseHeight: 100
            };
            
            await appService.generateCabinet(defaultDimensions);
            
            // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ - –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ—Ç –∂–µ —à–∫–∞—Ñ
            window.addEventListener('resize', () => {
                if (appService.currentCabinet) {
                    uiManager.renderCabinet(appService.currentCabinet);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>