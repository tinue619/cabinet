<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- Мета-теги против кеширования -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <title>PRKI - Конструктор Шкафов</title>
  <link rel="icon" type="image/svg+xml" href="logo.svg">
  <link rel="stylesheet" href="css/styles.css?v=20250722143107">
  <link rel="stylesheet" href="css/mobile-optimized.css?v=20250722143107">
</head>
<body>
  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">
            <img src="logo.svg" alt="PRKI Logo" style="width: 100%; height: 100%; object-fit: contain;">
          </div>
          <div class="logo-text">
            <div class="logo-name">
              <img src="name.svg" alt="PRKI" style="height: 28px; width: auto;">
            </div>
            <p>Конструктор шкафов</p>
          </div>
        </div>
      </div>
      
      <div class="sidebar-content">
        <!-- Переключатель видов -->
        <div class="view-toggle">
          <button id="view2d" class="view-btn active">
            <svg fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 7.5h16.5M3.75 3.75h16.5" />
            </svg>
            2D Редактор
          </button>
          <button id="view3d" class="view-btn">
            <svg fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
            </svg>
            3D Просмотр
          </button>
        </div>
        
        <div class="control-group">
          <label class="control-label">Ширина</label>
          <div class="input-wrapper">
            <input type="number" id="width" class="input-field" value="800" min="132" max="2000">
            <span class="input-unit">мм</span>
          </div>
        </div>
        
        <div class="control-group">
          <label class="control-label">Высота</label>
          <div class="input-wrapper">
            <input type="number" id="height" class="input-field" value="1800" min="132" max="3000">
            <span class="input-unit">мм</span>
          </div>
        </div>
        
        <div class="control-group">
          <label class="control-label">Глубина</label>
          <div class="input-wrapper">
            <input type="number" id="depth" class="input-field" value="500" min="100" max="1000">
            <span class="input-unit">мм</span>
          </div>
        </div>
        
        <div class="control-group">
          <label class="control-label">Цоколь</label>
          <div class="input-wrapper">
            <input type="number" id="base" class="input-field" value="100" min="60" max="200">
            <span class="input-unit">мм</span>
          </div>
        </div>
        
        <div class="button-group">
          <button id="apply" class="btn btn-primary">
            <svg fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
            </svg>
            Применить
          </button>
          
          <button id="editMode" class="btn btn-secondary">
            <svg fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
            </svg>
            Редактировать
          </button>
          
          <div class="btn-dropdown">
            <button id="addShelf" class="btn btn-secondary btn-dropdown-main">
              <svg fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18" />
              </svg>
              Добавить полку
            </button>
            <button class="btn btn-dropdown-arrow" data-target="shelfDropdown">
              <svg fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
              </svg>
            </button>
            <div class="dropdown-menu" id="shelfDropdown">
              <button class="dropdown-item" data-type="shelf" data-count="2">2 полки</button>
              <button class="dropdown-item" data-type="shelf" data-count="3">3 полки</button>
              <button class="dropdown-item" data-type="shelf" data-count="4">4 полки</button>
              <button class="dropdown-item" data-type="shelf" data-count="5">5 полок</button>
            </div>
          </div>
          
          <div class="btn-dropdown">
            <button id="addStand" class="btn btn-secondary btn-dropdown-main">
              <svg fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18" />
              </svg>
              Добавить стойку
            </button>
            <button class="btn btn-dropdown-arrow" data-target="standDropdown">
              <svg fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
              </svg>
            </button>
            <div class="dropdown-menu" id="standDropdown">
              <button class="dropdown-item" data-type="stand" data-count="2">2 стойки</button>
              <button class="dropdown-item" data-type="stand" data-count="3">3 стойки</button>
              <button class="dropdown-item" data-type="stand" data-count="4">4 стойки</button>
              <button class="dropdown-item" data-type="stand" data-count="5">5 стоек</button>
            </div>
          </div>
          
          <div class="btn-dropdown">
            <button id="addRod" class="btn btn-secondary btn-dropdown-main">
              <svg fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14" />
                <circle cx="19" cy="12" r="1" />
                <circle cx="5" cy="12" r="1" />
              </svg>
              Добавить штангу
            </button>
            <button class="btn btn-dropdown-arrow" data-target="rodDropdown">
              <svg fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
              </svg>
            </button>
            <div class="dropdown-menu" id="rodDropdown">
              <button class="dropdown-item" data-type="rod" data-count="1">1 штанга</button>
              <button class="dropdown-item" data-type="rod" data-count="2">2 штанги</button>
              <button class="dropdown-item" data-type="rod" data-count="3">3 штанги</button>
            </div>
          </div>
          
          <button id="deleteMode" class="btn btn-secondary">
            <svg fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>
            Удалить элементы
          </button>
          
          <button id="cancel" class="btn btn-tertiary">
            Отмена
          </button>
        </div>
        
        <div class="parts-section">
          <div class="parts-header">
            <h3>Детали</h3>
            <span class="parts-count" id="partsCount">0</span>
          </div>
          <div class="parts-list" id="partsList">
          </div>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="toolbar">
        <button id="mobile-menu" class="toolbar-btn mobile-menu-btn">
          <svg fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </button>
        
        <button id="toggleDimensions" class="toolbar-btn">
          <svg fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="m7.49 12-3.75 3.75m0 0 3.75 3.75m-3.75-3.75h16.5m0-7.5-3.75-3.75m3.75 3.75-3.75 3.75m3.75-3.75H3.74" />
          </svg>
          Размеры
        </button>
        
        <button id="undo" class="toolbar-btn" title="Отменить (Ctrl+Z)">
        <svg fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
        </svg>
        </button>
        
      <button id="redo" class="toolbar-btn" title="Повторить (Ctrl+Y)">
        <svg fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3" />
        </svg>
      </button>
      
      <button id="reset" class="toolbar-btn">
        <svg fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
        </svg>
        Сброс
      </button>
        
        <div class="toolbar-spacer"></div>
        
        <div class="toolbar-info">
          <svg fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
          </svg>
          Перетаскивайте элементы
        </div>
        
        <!-- Индикатор версии для проверки кеширования -->
        <div class="version-indicator" style="font-size: 10px; color: #666; margin-left: 10px;">
          v.1753176217279
        </div>
      </div>
      
      <div class="canvas-container cabinet-colors">
        <canvas id="canvas"></canvas>
        <canvas id="canvas3d" style="display: none;"></canvas>
        
        <!-- Контролы для 3D -->
        <div class="canvas-controls" id="canvas3dControls" style="display: none;">
          <button class="canvas-btn" id="resetView3d" title="Сбросить вид">
            <svg fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
          </button>
          <button class="canvas-btn" id="toggleWireframe" title="Каркасный вид">
            <svg fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-2.25-1.313M21 7.5v2.25m0-2.25l-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m18 0V18a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18V9.75m18 0V9a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9v.75m18 0A2.25 2.25 0 0019.5 12H4.5A2.25 2.25 0 003 9.75V12" />
            </svg>
          </button>
          
          <!-- Селектор материалов -->
          <div class="material-selector">
            <label for="materialSelect">Материал:</label>
            <select id="materialSelect" class="material-select">
              <option value="default">Обычный</option>
              <option value="Белый">Белый</option>
              <option value="Антрацит">Антрацит</option>
              <option value="Венге">Венге</option>
              <option value="Дуб Сонома">Дуб Сонома</option>
            </select>
            <button class="canvas-btn" id="reloadTextures" title="Перезагрузить текстуры">
              <svg fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Подсказки для 3D -->
        <div class="canvas-info" id="canvas3dInfo" style="display: none;">
          <div class="desktop-hint">🖱️ Левая кнопка: поворот камеры</div>
          <div class="desktop-hint">🎯 Колесо мыши: приближение/отдаление</div>
          <div class="desktop-hint">🎮 Редактирование только в 2D режиме</div>
          <div class="mobile-hint">👆 Один палец: поворот</div>
          <div class="mobile-hint">✌️ Два пальца: масштаб</div>
          <div class="mobile-hint">✏️ Редактирование в 2D</div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="notification" class="notification">
    <svg class="notification-icon" fill="none" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
    </svg>
    <span class="notification-text"></span>
  </div>
  
  <div id="keyboardHint" class="keyboard-hint">
    <kbd>←</kbd><kbd>→</kbd> Переместить стойку • 
    <kbd>↑</kbd><kbd>↓</kbd> Переместить полку • 
    <kbd>Shift</kbd> + стрелки для быстрого перемещения • 
    <kbd>Tab</kbd> Следующий • 
    <kbd>Delete</kbd> Удалить
  </div>

  <!-- Three.js библиотека -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <script src="js/config.js?v=20250722143107"></script>
  <script src="js/historyManager.js?v=20250722143107"></script>
  <script src="js/cabinet.js?v=20250722143107"></script>
  <script src="js/resizeHandler.js?v=20250722143107"></script>
  <script src="js/renderer.js?v=20250722143107"></script>
  <script src="js/renderer3d.js?v=20250722143107"></script>
  <script src="js/events.js?v=20250722143107"></script>
  
  <!-- Встроенный мобильный код -->
  <script>
    // Встроенный Mobile UI Manager
    class MobileUIManager {
      constructor() {
        this.isInitialized = false;
        this.editMode = false;
        this.deleteMode = false;
        this.selectedElement = null;
        
        if (this.isMobileDevice()) {
          this.init();
        }
      }

      init() {
        if (this.isInitialized) return;
        console.log('🚀 Инициализация встроенного мобильного UI...');
        
        this.addMobileStyles();
        this.createMobileElements();
        this.setupEventListeners();
        
        this.isInitialized = true;
        console.log('✅ Встроенный мобильный UI готов');
      }

      addMobileStyles() {
        const style = document.createElement('style');
        style.textContent = `
          @media (max-width: 768px) {
            /* Скрываем десктопные элементы */
            .sidebar {
              display: none !important;
            }
            .toolbar {
              display: none !important;
            }
            
            /* Растягиваем основной контент */
            .app-container {
              display: block !important;
            }
            .main-content {
              margin-left: 0 !important;
              width: 100vw !important;
              height: 100vh !important;
              position: fixed !important;
              top: 0 !important;
              left: 0 !important;
            }
            .canvas-container {
              padding: 0 !important;
              margin: 0 !important;
              width: 100vw !important;
              height: calc(100vh - 80px) !important;
              position: relative !important;
            }
            #canvas {
              width: 100vw !important;
              height: calc(100vh - 80px) !important;
              display: block !important;
              position: absolute !important;
              top: 0 !important;
              left: 0 !important;
            }
            
            /* Убираем скроллинг */
            body, html {
              overflow: hidden !important;
              margin: 0 !important;
              padding: 0 !important;
              height: 100vh !important;
            }
            
            /* Исправляем мобильную панель */
            .mobile-toolbar {
              position: fixed !important;
              bottom: 0 !important;
              left: 0 !important;
              right: 0 !important;
              z-index: 9999 !important;
              background: rgba(255, 255, 255, 0.95) !important;
              backdrop-filter: blur(10px) !important;
              border-top: 1px solid #e5e5e5 !important;
              padding: 8px !important;
              display: flex !important;
              gap: 6px !important;
              justify-content: space-around !important;
              box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
              height: 70px !important;
            }
            
            .mobile-tool-btn {
              display: flex !important;
              flex-direction: column !important;
              align-items: center !important;
              justify-content: center !important;
              background: none !important;
              border: none !important;
              padding: 6px 8px !important;
              border-radius: 8px !important;
              color: #333 !important;
              cursor: pointer !important;
              transition: all 0.2s !important;
              min-height: 54px !important;
              gap: 2px !important;
              font-size: 10px !important;
              min-width: 50px !important;
            }
          }
        `;
        document.head.appendChild(style);
      }

      createMobileElements() {
        this.createToolbar();
        this.createNotifications();
        this.adjustCanvasForMobile();
      }

      createToolbar() {
        if (document.querySelector('.mobile-toolbar')) return;
        
        const toolbar = document.createElement('div');
        toolbar.className = 'mobile-toolbar';
        
        toolbar.innerHTML = `
          <button class="mobile-tool-btn" data-tool="shelf">
            <svg fill="none" viewBox="0 0 24 24" style="width:18px;height:18px;">
              <path stroke="currentColor" stroke-width="2" d="M3 12h18"/>
            </svg>
            <span style="font-size:10px;">Полка</span>
          </button>
          
          <button class="mobile-tool-btn" data-tool="stand">
            <svg fill="none" viewBox="0 0 24 24" style="width:18px;height:18px;">
              <path stroke="currentColor" stroke-width="2" d="M12 3v18"/>
            </svg>
            <span style="font-size:10px;">Стойка</span>
          </button>
          
          <button class="mobile-tool-btn" data-tool="edit">
            <svg fill="none" viewBox="0 0 24 24" style="width:18px;height:18px;">
              <path stroke="currentColor" stroke-width="2" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"/>
            </svg>
            <span style="font-size:10px;">Редакт.</span>
          </button>
          
          <button class="mobile-tool-btn" data-tool="delete">
            <svg fill="none" viewBox="0 0 24 24" style="width:18px;height:18px;">
              <path stroke="currentColor" stroke-width="2" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/>
            </svg>
            <span style="font-size:10px;">Удалить</span>
          </button>
          
          <button class="mobile-tool-btn" data-tool="undo">
            <svg fill="none" viewBox="0 0 24 24" style="width:18px;height:18px;">
              <path stroke="currentColor" stroke-width="2" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"/>
            </svg>
            <span style="font-size:10px;">Отмена</span>
          </button>
        `;
        
        document.body.appendChild(toolbar);
        console.log('🔨 Мобильная панель создана');
      }

      getButtonStyle() {
        return `
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: none;
          border: none;
          padding: 8px 12px;
          border-radius: 8px;
          color: #333;
          cursor: pointer;
          transition: all 0.2s;
          min-height: 44px;
          gap: 4px;
        `;
      }

      createNotifications() {
        if (document.querySelector('.mobile-notifications')) return;
        
        const notifications = document.createElement('div');
        notifications.className = 'mobile-notifications';
        notifications.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1001;
        `;
        document.body.appendChild(notifications);
      }

      setupEventListeners() {
        document.body.addEventListener('click', (e) => {
          const toolBtn = e.target.closest('.mobile-tool-btn');
          if (toolBtn && toolBtn.dataset.tool) {
            e.preventDefault();
            e.stopPropagation();
            console.log('🔧 Нажата кнопка:', toolBtn.dataset.tool);
            this.handleToolClick(toolBtn.dataset.tool, toolBtn);
          }
        });
      }

      handleToolClick(tool, button) {
        console.log('🔧 Обработка:', tool);
        
        // Убираем активность со всех кнопок
        document.querySelectorAll('.mobile-tool-btn').forEach(btn => {
          btn.style.background = 'none';
        });

        switch (tool) {
          case 'shelf':
            this.activateTool('shelf', button);
            break;
          case 'stand':
            this.activateTool('stand', button);
            break;
          case 'edit':
            this.activateEditMode(button);
            break;
          case 'delete':
            this.activateDeleteMode(button);
            break;
          case 'undo':
            this.executeUndo();
            break;
        }
      }

      activateTool(mode, button) {
        console.log('⚡ Активация инструмента:', mode);
        button.style.background = '#007AFF';
        button.style.color = 'white';
        
        if (window.setMode) {
          window.setMode(mode);
          this.showNotification(`Режим ${mode} активирован`);
        } else {
          console.error('setMode не найден');
        }
      }

      activateEditMode(button) {
        console.log('✏️ Активация режима редактирования');
        this.editMode = true;
        button.style.background = '#007AFF';
        button.style.color = 'white';
        
        if (window.setMode) {
          window.setMode('edit');
        }
        
        this.showNotification('Режим редактирования активирован. Нажмите на элемент.');
      }

      activateDeleteMode(button) {
        console.log('🗑️ Активация режима удаления');
        this.deleteMode = true;
        button.style.background = '#FF3B30';
        button.style.color = 'white';
        
        if (window.setMode) {
          window.setMode('delete');
        }
        
        this.showNotification('Режим удаления активирован. Нажмите на элемент.');
      }

      executeUndo() {
        if (window.undo) {
          window.undo();
          this.showNotification('Действие отменено');
        }
      }

      showNotification(message) {
        const container = document.querySelector('.mobile-notifications');
        if (!container) return;
        
        const notification = document.createElement('div');
        notification.style.cssText = `
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          margin-bottom: 8px;
          font-size: 14px;
          max-width: 250px;
        `;
        notification.textContent = message;
        
        container.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 3000);
      }

      isMobileDevice() {
        return window.innerWidth <= 768 || 'ontouchstart' in window;
      }
      
      adjustCanvasForMobile() {
        const canvas = document.getElementById('canvas');
        if (canvas && this.isMobileDevice()) {
          // Обновляем размеры canvas для мобильного
          const updateCanvas = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 80; // Учитываем высоту панели 70px + отступ
            
            // Перерисовываем
            setTimeout(() => {
              if (window.app && window.app.renderer2d && window.app.renderer2d.updateCanvas) {
                window.app.renderer2d.updateCanvas();
              } else if (window.render) {
                window.render();
              }
            }, 100);
          };
          
          // Обновляем сразу и при изменении размеров
          setTimeout(updateCanvas, 500);
          
          window.addEventListener('orientationchange', () => {
            setTimeout(updateCanvas, 200);
          });
          
          window.addEventListener('resize', () => {
            setTimeout(updateCanvas, 100);
          });
        }
      }
    }

    // Простой Touch Handler
    class SimpleTouchHandler {
      constructor(app) {
        this.app = app;
        this.canvas = document.getElementById('canvas');
        this.init();
      }

      init() {
        if (!this.canvas) return;
        
        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e), { passive: false });
        this.canvas.addEventListener('touchend', (e) => this.handleTouch(e), { passive: false });
      }

      handleTouch(e) {
        e.preventDefault();
        
        if (e.type === 'touchend' && e.changedTouches.length === 1) {
          const touch = e.changedTouches[0];
          const rect = this.canvas.getBoundingClientRect();
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;
          
          console.log('👆 Touch в координатах:', x, y);
          
          // Проверяем активные режимы
          const activeTool = document.querySelector('.mobile-tool-btn[style*="background: rgb(0, 122, 255)"], .mobile-tool-btn[style*="background: rgb(255, 59, 48)"]');
          
          if (activeTool) {
            const tool = activeTool.dataset.tool;
            console.log('👆 Активный инструмент:', tool);
            
            if (tool === 'edit' || tool === 'delete') {
              const element = this.findElementAt(x, y);
              if (element) {
                if (tool === 'edit') {
                  this.handleEdit(element);
                } else {
                  this.handleDelete(element);
                }
                return;
              }
            }
          }
          
          // Обычный клик
          this.forwardClick(x, y);
        }
      }

      findElementAt(x, y) {
        if (window.app && window.app.findElementAt) {
          return window.app.findElementAt(x, y);
        }
        return null;
      }

      handleEdit(element) {
        console.log('✏️ Редактирование элемента:', element);
        if (window.mobileUI) {
          window.mobileUI.showNotification(`Редактирование ${element.displayName || 'элемента'}`);
        }
      }

      handleDelete(element) {
        console.log('🗑️ Удаление элемента:', element);
        if (confirm(`Удалить ${element.displayName || 'элемент'}?`)) {
          if (window.app && window.app.deleteElement) {
            window.app.deleteElement(element);
            if (window.mobileUI) {
              window.mobileUI.showNotification('Элемент удален');
            }
          }
        }
      }

      forwardClick(x, y) {
        if (typeof onCanvasClick === 'function') {
          const fakeEvent = {
            clientX: x,
            clientY: y,
            preventDefault: () => {},
            stopPropagation: () => {}
          };
          onCanvasClick(fakeEvent);
        }
      }
    }
  </script>
  
  <script src="js/app.js?v=20250722143107"></script>
  
  <script>
    // Инициализация мобильной поддержки
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Инициализация приложения...');
      
      // Проверяем мобильное устройство
      const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
      
      if (isMobile) {
        console.log('📱 Мобильное устройство обнаружено');
        
        // Инициализируем мобильные модули
        if (typeof MobileUIManager !== 'undefined') {
          console.log('Инициализация MobileUIManager...');
          window.mobileUI = new MobileUIManager();
        } else {
          console.error('MobileUIManager не найден!');
        }
        
        // Ждем инициализации основного приложения
        const initMobile = () => {
          if (window.app && typeof TouchHandler !== 'undefined') {
            console.log('Инициализация TouchHandler...');
            window.touchHandler = new TouchHandler(window.app);
            console.log('✅ Мобильные модули инициализированы');
          } else {
            console.log('Ожидание загрузки основного приложения...');
            setTimeout(initMobile, 100);
          }
        };
        
    setTimeout(initMobile, 500);
      }
      
      window.testMobileSettings = () => window.mobileUI.testOpenSettings();
      window.testMobileClose = () => window.mobileUI.testCloseSettings();
      window.testEditMode = () => window.mobileUI.testEditMode();
      window.testDeleteMode = () => window.mobileUI.testDeleteMode();
      
      // Добавляем простой тест кнопок
      window.testButtons = () => {
        console.log('🧪 Тестирование кнопок...');
        const toolbar = document.querySelector('.mobile-toolbar');
        console.log('🧪 Панель инструментов:', toolbar);
        
        if (toolbar) {
          const buttons = toolbar.querySelectorAll('.mobile-tool-btn');
          console.log('🧪 Найдено кнопок:', buttons.length);
          
          buttons.forEach((btn, i) => {
            console.log(`🧪 Кнопка ${i}:`, {
              element: btn,
              tool: btn.dataset.tool,
              visible: btn.offsetWidth > 0 && btn.offsetHeight > 0,
              classList: [...btn.classList]
            });
          });
          
          // Тестируем клик по кнопке редактирования
          const editBtn = toolbar.querySelector('[data-tool="edit"]');
          if (editBtn) {
            console.log('🧪 Кликаем по кнопке редактирования...');
            editBtn.click();
          } else {
            console.error('🧪 Кнопка редактирования не найдена!');
          }
        } else {
          console.error('🧪 Панель инструментов не найдена!');
        }
      };
    });
  </script>
</body>
</html>