<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –¢–µ—Å—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤ –ø–∞–Ω–µ–ª–µ–π</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: #333;
        }
        
        .header {
            text-align: center;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 2.5em;
        }
        
        .fix-info {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .fix-info h3 {
            margin: 0 0 15px 0;
            color: #2e7d32;
        }
        
        .overlap-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .before {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            font-family: monospace;
        }
        
        .after {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 15px;
            font-family: monospace;
        }
        
        .results-container {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'Consolas', monospace;
            font-size: 14px;
        }
        
        .success { border-color: #28a745; background: #d4edda; color: #155724; }
        .error { border-color: #dc3545; background: #f8d7da; color: #721c24; }
        .info { border-color: #17a2b8; background: #d1ecf1; color: #0c5460; }
        .warning { border-color: #ffc107; background: #fff3cd; color: #856404; }
        
        canvas {
            border: 2px solid #bdc3c7;
            background: #ffffff;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            display: block;
            margin: 20px auto;
        }
        
        .canvas-container {
            text-align: center;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #333;
        }
        
        @media (max-width: 768px) {
            .overlap-analysis {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–ï–†–ï–•–õ–ï–°–¢–û–í</h1>
        <p>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è TOP –ø–∞–Ω–µ–ª–∏</p>
    </div>

    <div class="fix-info">
        <h3>üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–∞:</h3>
        
        <div class="overlap-analysis">
            <div class="before">
                <strong>‚ùå –î–û (–ø–µ—Ä–µ—Ö–ª–µ—Å—Ç):</strong><br>
                LEFT_SIDE: x=0, width=16<br>
                TOP: x=0, width=800<br>
                <br>
                –ó–∞–Ω–∏–º–∞—é—Ç –æ–±–ª–∞—Å—Ç—å:<br>
                LEFT_SIDE: [0...16]<br>
                TOP: [0...800] ‚ùå –ü–ï–†–ï–•–õ–ï–°–¢!<br>
                <br>
                –ö–æ–Ω—Ñ–ª–∏–∫—Ç –≤ –∑–æ–Ω–µ [0...16]
            </div>
            
            <div class="after">
                <strong>‚úÖ –ü–û–°–õ–ï (–±–µ–∑ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–∞):</strong><br>
                LEFT_SIDE: x=0, width=16<br>
                TOP: x=16, width=768<br>
                <br>
                –ó–∞–Ω–∏–º–∞—é—Ç –æ–±–ª–∞—Å—Ç—å:<br>
                LEFT_SIDE: [0...16]<br>
                TOP: [16...784] ‚úÖ –ë–ï–ó –ü–ï–†–ï–•–õ–ï–°–¢–ê!<br>
                <br>
                –ö—Ä—ã—à–∞ —Ç–æ—á–Ω–æ –º–µ–∂–¥—É –±–æ–∫–æ–≤–∏–Ω–∞–º–∏
            </div>
        </div>
    </div>

    <div class="results-container">
        <h2>üî¨ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤:</h2>
        <div id="results"></div>
    </div>

    <div class="canvas-container">
        <h2>üé® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–µ–π (–±–µ–∑ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤):</h2>
        <canvas id="canvas" width="800" height="600"></canvas>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>LEFT_SIDE</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>RIGHT_SIDE</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>TOP (–∫—Ä—ã—à–∞)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span>BOTTOM</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>FRONT_BASE</span>
            </div>
        </div>
    </div>

    <script type="module">
        // üèóÔ∏è UI LAYER - –¢–µ—Å—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤
        // –¢–û–õ–¨–ö–û –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ë–ï–ó –ª–æ–≥–∏–∫–∏

        let results = document.getElementById('results');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }

        async function runOverlapTest() {
            try {
                log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤ –ø–∞–Ω–µ–ª–µ–π...', 'info');

                // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —è–¥—Ä–æ
                const { Cabinet } = await import('./new_core/entities/Cabinet.js');
                const { CABINET_DNA } = await import('./new_core/cabinet-dna.js');
                
                log(`‚úÖ –Ø–¥—Ä–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –≤–µ—Ä—Å–∏—è –î–ù–ö: ${CABINET_DNA.SIGNATURE.version}`, 'success');
                log(`üîß –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${CABINET_DNA.SIGNATURE.panels || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`, 'info');

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —à–∫–∞—Ñ
                const cabinet = new Cabinet({
                    width: 800,
                    height: 2000,
                    depth: 600,
                    baseHeight: 100
                });

                log(`üèóÔ∏è –®–∫–∞—Ñ —Å–æ–∑–¥–∞–Ω: ${cabinet.dimensions.width}√ó${cabinet.dimensions.height}√ó${cabinet.dimensions.depth}`, 'success');

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª–∏
                cabinet.generate();
                const stats = cabinet.getStats();
                log(`‚öôÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${stats.panelsCount} –ø–∞–Ω–µ–ª–µ–π`, 'success');

                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç—ã –ø–∞–Ω–µ–ª–µ–π
                log('üîç –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤ –ø–∞–Ω–µ–ª–µ–π –ø–æ X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ:', 'info');
                
                const panels = cabinet.getPanels();
                const criticalPanels = ['LEFT_SIDE', 'RIGHT_SIDE', 'TOP', 'BOTTOM'];
                let hasOverlaps = false;
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –∑–∞–Ω—è—Ç—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π –ø–æ X
                const occupiedRegions = [];
                
                criticalPanels.forEach(panelKey => {
                    const panel = cabinet.getPanel(panelKey);
                    if (!panel) return;
                    
                    const pos = panel.position;
                    const size = panel.dimensions;
                    const startX = pos.x;
                    const endX = pos.x + size.width;
                    
                    log(`üìê ${panelKey}: x=${startX}...${endX} (width=${size.width})`, 'info');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç—ã —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –æ–±–ª–∞—Å—Ç—è–º–∏
                    for (const region of occupiedRegions) {
                        const overlapStart = Math.max(startX, region.startX);
                        const overlapEnd = Math.min(endX, region.endX);
                        
                        if (overlapStart < overlapEnd) {
                            log(`‚ùå –ü–ï–†–ï–•–õ–ï–°–¢: ${panelKey} –∏ ${region.panelKey} –≤ –æ–±–ª–∞—Å—Ç–∏ [${overlapStart}...${overlapEnd}]`, 'error');
                            hasOverlaps = true;
                        }
                    }
                    
                    occupiedRegions.push({
                        panelKey,
                        startX,
                        endX
                    });
                });
                
                if (!hasOverlaps) {
                    log('‚úÖ –ü–ï–†–ï–•–õ–ï–°–¢–û–í –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù–û! –í—Å–µ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                } else {
                    log('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç—ã –ø–∞–Ω–µ–ª–µ–π', 'warning');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è TOP –ø–∞–Ω–µ–ª–∏
                log('üéØ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ TOP –ø–∞–Ω–µ–ª–∏:', 'info');
                
                const leftSide = cabinet.getPanel('LEFT_SIDE');
                const rightSide = cabinet.getPanel('RIGHT_SIDE');
                const topPanel = cabinet.getPanel('TOP');
                
                if (leftSide && rightSide && topPanel) {
                    const expectedTopX = leftSide.dimensions.width; // 16
                    const expectedTopWidth = cabinet.dimensions.width - 2 * cabinet.materialThickness; // 768
                    const expectedTopEnd = expectedTopX + expectedTopWidth; // 784
                    const rightSideX = rightSide.position.x; // 784
                    
                    log(`  –û–∂–∏–¥–∞–µ–º–∞—è –ø–æ–∑–∏—Ü–∏—è TOP: x=${expectedTopX}`, 'info');
                    log(`  –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è TOP: x=${topPanel.position.x}`, 'info');
                    log(`  –û–∂–∏–¥–∞–µ–º–∞—è —à–∏—Ä–∏–Ω–∞ TOP: ${expectedTopWidth}–º–º`, 'info');
                    log(`  –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ TOP: ${topPanel.dimensions.width}–º–º`, 'info');
                    
                    const positionCorrect = topPanel.position.x === expectedTopX;
                    const widthCorrect = topPanel.dimensions.width === expectedTopWidth;
                    const fitsCorrectly = (topPanel.position.x + topPanel.dimensions.width) === rightSideX;
                    
                    if (positionCorrect && widthCorrect && fitsCorrectly) {
                        log('‚úÖ TOP –ø–∞–Ω–µ–ª—å –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –º–µ–∂–¥—É –±–æ–∫–æ–≤–∏–Ω–∞–º–∏!', 'success');
                    } else {
                        if (!positionCorrect) log(`‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è TOP: –æ–∂–∏–¥–∞–ª–æ—Å—å x=${expectedTopX}`, 'error');
                        if (!widthCorrect) log(`‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —à–∏—Ä–∏–Ω–∞ TOP: –æ–∂–∏–¥–∞–ª–æ—Å—å ${expectedTopWidth}–º–º`, 'error');
                        if (!fitsCorrectly) log(`‚ùå TOP –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—É—é –±–æ–∫–æ–≤–∏–Ω—É`, 'error');
                    }
                }

                // –†–∏—Å—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                log('üé® –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤...', 'info');
                drawPanelsOverlapAnalysis(panels, cabinet.dimensions);
                
                log('üèÅ –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');

            } catch (error) {
                log(`üí• –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${error.message}`, 'error');
                console.error('Overlap test error:', error);
            }
        }

        function drawPanelsOverlapAnalysis(panels, dimensions) {
            // –û—á–∏—â–∞–µ–º canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ú–∞—Å—à—Ç–∞–± –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const scale = Math.min(
                (canvas.width - 100) / dimensions.width,
                (canvas.height - 100) / dimensions.height
            );
            
            const offsetX = (canvas.width - dimensions.width * scale) / 2;
            const offsetY = (canvas.height - dimensions.height * scale) / 2;

            // –¶–≤–µ—Ç–∞ –¥–ª—è –ø–∞–Ω–µ–ª–µ–π
            const colors = {
                'LEFT_SIDE': '#3498db',      // –°–∏–Ω–∏–π
                'RIGHT_SIDE': '#9b59b6',     // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
                'TOP': '#e74c3c',            // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∫—Ä—ã—à–∏
                'BOTTOM': '#f39c12',         // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                'FRONT_BASE': '#2ecc71',     // –ó–µ–ª–µ–Ω—ã–π
                'BACK_BASE': '#34495e',      // –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π
                'BACK_WALL': '#f1c40f',      // –ñ–µ–ª—Ç—ã–π
                'FACADE': '#95a5a6'          // –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π
            };

            // –†–∏—Å—É–µ–º –∫–æ–Ω—Ç—É—Ä —à–∫–∞—Ñ–∞
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 3;
            ctx.strokeRect(offsetX, offsetY, dimensions.width * scale, dimensions.height * scale);

            // –†–∏—Å—É–µ–º –ø–∞–Ω–µ–ª–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –ø–µ—Ä–µ—Ö–ª–µ—Å—Ç–æ–≤
            panels.forEach(panel => {
                const pos = panel.position;
                const size = panel.dimensions;
                
                const x = offsetX + pos.x * scale;
                const y = offsetY + pos.y * scale;
                const w = size.width * scale;
                const h = size.height * scale;

                // –ó–∞–ª–∏–≤–∫–∞
                ctx.fillStyle = colors[panel.key] || '#bdc3c7';
                ctx.fillRect(x, y, w, h);

                // –û–±–≤–æ–¥–∫–∞
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, w, h);

                // –ü–æ–¥–ø–∏—Å—å —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const text = `${panel.key}\nx=${pos.x}, w=${size.width}`;
                const lines = text.split('\n');
                lines.forEach((line, i) => {
                    // –ö–æ–Ω—Ç—É—Ä –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = 3;
                    ctx.strokeText(line, x + w/2, y + h/2 - 6 + i * 12);
                    ctx.fillText(line, x + w/2, y + h/2 - 6 + i * 12);
                });
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 2;
            ctx.font = '12px Arial';
            ctx.fillStyle = '#e74c3c';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            const topY = offsetY - 30;
            ctx.fillText(`–û–±—â–∞—è —à–∏—Ä–∏–Ω–∞: ${dimensions.width}–º–º`, offsetX + (dimensions.width * scale) / 2, topY);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—â–∏–Ω—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            const leftX = offsetX - 80;
            ctx.fillText(`–¢–æ–ª—â–∏–Ω–∞: ${16}–º–º`, leftX, offsetY + 20);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        runOverlapTest();

    </script>
</body>
</html>