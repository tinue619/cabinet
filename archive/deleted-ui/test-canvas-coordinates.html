<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ –¢–µ—Å—Ç –Ω–æ–≤–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã Canvas</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: #333;
        }
        
        .header {
            text-align: center;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 2.5em;
        }
        
        .coordinate-info {
            background: #e8f4fd;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Consolas', monospace;
        }
        
        .coordinate-info h3 {
            margin: 0 0 15px 0;
            color: #2980b9;
        }
        
        .old-system {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 5px 0;
        }
        
        .new-system {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 5px 0;
        }
        
        .results-container {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'Consolas', monospace;
            font-size: 14px;
        }
        
        .success { border-color: #28a745; background: #d4edda; color: #155724; }
        .error { border-color: #dc3545; background: #f8d7da; color: #721c24; }
        .info { border-color: #17a2b8; background: #d1ecf1; color: #0c5460; }
        .warning { border-color: #ffc107; background: #fff3cd; color: #856404; }
        
        canvas {
            border: 2px solid #bdc3c7;
            background: #ffffff;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            display: block;
            margin: 20px auto;
        }
        
        .canvas-container {
            text-align: center;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîÑ –ö–û–û–†–î–ò–ù–ê–¢–ù–ê–Ø –°–ò–°–¢–ï–ú–ê CANVAS</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ Canvas-—Å—Ç–∏–ª—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
    </div>

    <div class="coordinate-info">
        <h3>üìê –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ:</h3>
        
        <div class="old-system">
            <strong>‚ùå –°–¢–ê–†–ê–Ø —Å–∏—Å—Ç–µ–º–∞ (—Å–º–µ—à–∞–Ω–Ω–∞—è):</strong><br>
            ‚Ä¢ Y=0 –º–æ–≥–ª–æ –±—ã—Ç—å –∫–∞–∫ –≤–≤–µ—Ä—Ö—É, —Ç–∞–∫ –∏ –≤–Ω–∏–∑—É<br>
            ‚Ä¢ –†–∞–∑–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ä–∞–∑–Ω—É—é –ª–æ–≥–∏–∫—É<br>
            ‚Ä¢ –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö –ø–æ–∑–∏—Ü–∏–π
        </div>
        
        <div class="new-system">
            <strong>‚úÖ –ù–û–í–ê–Ø —Å–∏—Å—Ç–µ–º–∞ (Canvas-—Å—Ç–∏–ª—å):</strong><br>
            ‚Ä¢ Y=0 –≤—Å–µ–≥–¥–∞ –≤–≤–µ—Ä—Ö—É —à–∫–∞—Ñ–∞<br>
            ‚Ä¢ Y=height –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É —à–∫–∞—Ñ–∞<br>
            ‚Ä¢ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –ø–∞–Ω–µ–ª–µ–π<br>
            ‚Ä¢ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º Canvas API
        </div>
    </div>

    <div class="results-container">
        <h2>üî¨ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:</h2>
        <div id="results"></div>
    </div>

    <div class="canvas-container">
        <h2>üé® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã Canvas):</h2>
        <canvas id="canvas" width="800" height="600"></canvas>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>TOP (–∫—Ä—ã—à–∞)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>BOTTOM (–¥–Ω–æ)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>FRONT_BASE (—Ü–æ–∫–æ–ª—å –ü)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span>BACK_BASE (—Ü–æ–∫–æ–ª—å –ó)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>FACADE (—Ñ–∞—Å–∞–¥)</span>
            </div>
        </div>
    </div>

    <script type="module">
        // üèóÔ∏è UI LAYER - –¢–µ—Å—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã Canvas
        // –¢–û–õ–¨–ö–û –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ë–ï–ó –ª–æ–≥–∏–∫–∏

        let results = document.getElementById('results');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }

        async function runCoordinateTest() {
            try {
                log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã Canvas...', 'info');

                // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —è–¥—Ä–æ
                const { Cabinet } = await import('./new_core/entities/Cabinet.js');
                const { CABINET_DNA } = await import('./new_core/cabinet-dna.js');
                
                log(`‚úÖ –Ø–¥—Ä–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –≤–µ—Ä—Å–∏—è –î–ù–ö: ${CABINET_DNA.SIGNATURE.version}`, 'success');
                log(`üîÑ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: ${CABINET_DNA.SIGNATURE.coordinates || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`, 'info');

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —à–∫–∞—Ñ
                const cabinet = new Cabinet({
                    width: 800,
                    height: 2000,
                    depth: 600,
                    baseHeight: 100
                });

                log(`üèóÔ∏è –®–∫–∞—Ñ —Å–æ–∑–¥–∞–Ω: ${cabinet.dimensions.width}√ó${cabinet.dimensions.height}√ó${cabinet.dimensions.depth}`, 'success');

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª–∏
                cabinet.generate();
                const stats = cabinet.getStats();
                log(`‚öôÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${stats.panelsCount} –ø–∞–Ω–µ–ª–µ–π`, 'success');

                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å–µ—Ö –ø–∞–Ω–µ–ª–µ–π
                const panels = cabinet.getPanels();
                const dims = cabinet.dimensions;
                
                log('üìã –ê–Ω–∞–ª–∏–∑ Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (Canvas-—Å—Ç–∏–ª—å, Y=0 –≤–≤–µ—Ä—Ö—É):', 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –ø–∞–Ω–µ–ª–∏
                const criticalPanels = ['TOP', 'BOTTOM', 'FRONT_BASE', 'BACK_BASE', 'FACADE'];
                let allCorrect = true;
                
                criticalPanels.forEach(panelKey => {
                    const panel = cabinet.getPanel(panelKey);
                    if (!panel) {
                        log(`‚ùå –ü–∞–Ω–µ–ª—å ${panelKey} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`, 'error');
                        allCorrect = false;
                        return;
                    }
                    
                    const y = panel.position.y;
                    const height = panel.dimensions.height;
                    
                    let expectedY, description, isCorrect = true;
                    
                    switch(panelKey) {
                        case 'TOP':
                            expectedY = 0;
                            description = '–∫—Ä—ã—à–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É';
                            isCorrect = (y === 0);
                            break;
                            
                        case 'BOTTOM':
                            expectedY = dims.height - cabinet.dimensions.baseHeight - 16; // y - b - t
                            description = '–¥–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞–¥ —Ü–æ–∫–æ–ª–µ–º';
                            isCorrect = (y === expectedY);
                            break;
                            
                        case 'FRONT_BASE':
                        case 'BACK_BASE':
                            expectedY = dims.height - cabinet.dimensions.baseHeight; // y - b
                            description = '—Ü–æ–∫–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–Ω–∏–∑—É';
                            isCorrect = (y === expectedY);
                            break;
                            
                        case 'FACADE':
                            expectedY = cabinet.dimensions.baseHeight; // b
                            description = '—Ñ–∞—Å–∞–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–¥ —Ü–æ–∫–æ–ª–µ–º';
                            isCorrect = (y === expectedY);
                            break;
                    }
                    
                    if (isCorrect) {
                        log(`‚úÖ ${panelKey}: y=${y} (${description})`, 'success');
                    } else {
                        log(`‚ùå ${panelKey}: y=${y}, –æ–∂–∏–¥–∞–ª–æ—Å—å y=${expectedY} (${description})`, 'error');
                        allCorrect = false;
                    }
                });
                
                if (allCorrect) {
                    log('üéâ –í–°–ï –ö–û–û–†–î–ò–ù–ê–¢–´ –°–û–û–¢–í–ï–¢–°–¢–í–£–Æ–¢ CANVAS-–°–¢–ò–õ–Æ!', 'success');
                } else {
                    log('‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö', 'warning');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑):', 'info');
                
                const topPanel = cabinet.getPanel('TOP');
                const facadePanel = cabinet.getPanel('FACADE');
                const bottomPanel = cabinet.getPanel('BOTTOM');
                const frontBasePanel = cabinet.getPanel('FRONT_BASE');
                
                if (topPanel && facadePanel && bottomPanel && frontBasePanel) {
                    const sequence = [
                        { name: 'TOP', y: topPanel.position.y },
                        { name: 'FACADE', y: facadePanel.position.y },
                        { name: 'BOTTOM', y: bottomPanel.position.y },
                        { name: 'FRONT_BASE', y: frontBasePanel.position.y }
                    ];
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Y —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                    let sequenceCorrect = true;
                    for (let i = 1; i < sequence.length; i++) {
                        if (sequence[i].y <= sequence[i-1].y) {
                            sequenceCorrect = false;
                            break;
                        }
                    }
                    
                    if (sequenceCorrect) {
                        log('‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ (TOP ‚Üí FACADE ‚Üí BOTTOM ‚Üí FRONT_BASE)', 'success');
                        sequence.forEach(item => {
                            log(`   ${item.name}: y=${item.y}`, 'info');
                        });
                    } else {
                        log('‚ùå –ù–∞—Ä—É—à–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç', 'error');
                    }
                }

                // –†–∏—Å—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                log('üé® –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —à–∫–∞—Ñ –≤ Canvas-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö...', 'info');
                drawCabinetCanvas(panels, cabinet.dimensions);
                
                log('üèÅ –¢–µ—Å—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');

            } catch (error) {
                log(`üí• –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
                console.error('Coordinate test error:', error);
            }
        }

        function drawCabinetCanvas(panels, dimensions) {
            // –û—á–∏—â–∞–µ–º canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ú–∞—Å—à—Ç–∞–± –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const scale = Math.min(
                (canvas.width - 100) / dimensions.width,
                (canvas.height - 100) / dimensions.height
            );
            
            const offsetX = (canvas.width - dimensions.width * scale) / 2;
            const offsetY = (canvas.height - dimensions.height * scale) / 2;

            // –¶–≤–µ—Ç–∞ –¥–ª—è –ø–∞–Ω–µ–ª–µ–π
            const colors = {
                'TOP': '#e74c3c',           // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∫—Ä—ã—à–∏
                'BOTTOM': '#3498db',        // –°–∏–Ω–∏–π –¥–ª—è –¥–Ω–∞
                'FRONT_BASE': '#2ecc71',    // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –ø–µ—Ä–µ–¥–Ω–µ–≥–æ —Ü–æ–∫–æ–ª—è
                'BACK_BASE': '#f39c12',     // –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –∑–∞–¥–Ω–µ–≥–æ —Ü–æ–∫–æ–ª—è
                'FACADE': '#9b59b6',        // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è —Ñ–∞—Å–∞–¥–∞
                'LEFT_SIDE': '#95a5a6',     // –°–µ—Ä—ã–π –¥–ª—è –±–æ–∫–æ–≤–∏–Ω
                'RIGHT_SIDE': '#95a5a6',
                'BACK_WALL': '#f1c40f'      // –ñ–µ–ª—Ç—ã–π –¥–ª—è –∑–∞–¥–Ω–µ–π —Å—Ç–µ–Ω–∫–∏
            };

            // –†–∏—Å—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—É—é —Å–µ—Ç–∫—É
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = offsetX + (i * dimensions.width * scale / 10);
                const y = offsetY + (i * dimensions.height * scale / 10);
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                ctx.beginPath();
                ctx.moveTo(x, offsetY);
                ctx.lineTo(x, offsetY + dimensions.height * scale);
                ctx.stroke();
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                ctx.beginPath();
                ctx.moveTo(offsetX, y);
                ctx.lineTo(offsetX + dimensions.width * scale, y);
                ctx.stroke();
            }

            // –ü–æ–¥–ø–∏—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            ctx.fillStyle = '#7f8c8d';
            ctx.font = '12px Arial';
            ctx.fillText('Y=0 (–≤–µ—Ä—Ö)', offsetX - 60, offsetY + 5);
            ctx.fillText(`Y=${dimensions.height} (–Ω–∏–∑)`, offsetX - 80, offsetY + dimensions.height * scale + 5);

            // –†–∏—Å—É–µ–º –æ–±—â–∏–π –∫–æ–Ω—Ç—É—Ä —à–∫–∞—Ñ–∞
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 3;
            ctx.strokeRect(offsetX, offsetY, dimensions.width * scale, dimensions.height * scale);

            // –†–∏—Å—É–µ–º –ø–∞–Ω–µ–ª–∏
            panels.forEach(panel => {
                const pos = panel.position;
                const size = panel.dimensions;
                
                // Canvas –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (Y —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ)
                const x = offsetX + pos.x * scale;
                const y = offsetY + pos.y * scale;
                const w = size.width * scale;
                const h = size.height * scale;

                // –ó–∞–ª–∏–≤–∫–∞
                ctx.fillStyle = colors[panel.key] || '#bdc3c7';
                ctx.fillRect(x, y, w, h);

                // –û–±–≤–æ–¥–∫–∞
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, w, h);

                // –ü–æ–¥–ø–∏—Å—å —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                ctx.fillStyle = '#2c3e50';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const text = `${panel.key}\ny=${pos.y}`;
                const lines = text.split('\n');
                lines.forEach((line, i) => {
                    ctx.fillText(line, x + w/2, y + h/2 - 5 + i * 12);
                });
            });

            // –°—Ç—Ä–µ–ª–∫–∞ Y-–æ—Å–∏
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(offsetX - 30, offsetY);
            ctx.lineTo(offsetX - 30, offsetY + dimensions.height * scale);
            ctx.stroke();
            
            // –°—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑
            ctx.beginPath();
            ctx.moveTo(offsetX - 35, offsetY + dimensions.height * scale - 10);
            ctx.lineTo(offsetX - 30, offsetY + dimensions.height * scale);
            ctx.lineTo(offsetX - 25, offsetY + dimensions.height * scale - 10);
            ctx.stroke();
            
            ctx.fillStyle = '#e74c3c';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Y+', offsetX - 30, offsetY + dimensions.height * scale + 20);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        runCoordinateTest();

    </script>
</body>
</html>